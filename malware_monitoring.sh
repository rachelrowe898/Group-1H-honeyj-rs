#!/bin/bash

# directory monitoring for malware files downloaded

if [ $# -ne 3 ]
then
  echo "Usage $0 <container name> <malware dest dir/> <container code>"
  exit 1
fi

download_dir="/var/lib/lxc/$1/rootfs/var/log/.downloads"
count=1
sudo inotifywait -q -m $download_dir -e create |
  while read dir action file; do
    if [ "$action" = "CREATE" ]
    then
      sleep 5
      #add malware id to end
      copyfile="$2$file-$3$count"
      #remove executable
      sudo chmod a-x "$download_dir/$file"
      #mv out container to dest
      sudo mv "$download_dir/$file" "$copyfile"
      #zip malware
      sudo gzip "$copyfile"

      count=$(( $count + 1 ))
    fi
  done
